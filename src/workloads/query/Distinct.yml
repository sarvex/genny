SchemaVersion: 2018-07-01
Owner: "@mongodb/query-execution"
Description: |
  TODO: add description

Keywords:
- distinct

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone
    branch_name:
      $neq:
      - v4.0
      - v4.2
      - v4.4

GlobalDefaults:
  MaxPhases: &maxPhases 29
  Database: &db distinct
  DocumentCount: &docCount 1e5
  # The Loader actor creates collections named "Collection<N>" where N corresponds to the thread's
  # number. We'll use a single collection, created by a single thread, so it becomes 'Collection0'.
  Collection: &coll Collection0

ActorTemplates:
- TemplateName: CreateDataset
  Config:
    Name: "CreateDataset"
    Type: Loader
    Threads: 1
    Phases:
      OnlyActiveInPhases:
        Active: [{^Parameter: {Name: "OnlyActiveInPhase", Default: 1024}}]
        NopInPhasesUpTo: *maxPhases
        PhaseConfig:
          Threads: 1
          Repeat: 1
          Database: *db
          CollectionCount: 1
          DocumentCount: *docCount
          BatchSize: 1000
          Document:
            _id: {^Inc: {start: 0}}
            value: {^RandomInt: {
              distribution: uniform,
              min: 0,
              max: {^Parameter: {Name: "Cardinality", Default: -1}}
            }}
          Indexes:
          - keys: {value: 1}

- TemplateName: Distinct
  Config:
    Name: {^Parameter: {Name: "Name", Default: "Distinct"}}
    Type: RunCommand
    Threads: {^Parameter: {Name: "Threads", Default: 1}}
    Phases:
      OnlyActiveInPhases:
        Active: [{^Parameter: {Name: "OnlyActiveInPhase", Default: 1024}}]
        NopInPhasesUpTo: *maxPhases
        PhaseConfig:
            Repeat: 200
            Database: *db
            Operation:
              OperationMetricsName: Distinct
              OperationName: RunCommand
              OperationCommand:
                distinct: *coll
                key: value

# *0 - create dataset
# *1 - *3 - compute distinct values for various number of threads (indexed)
# *4 - unused
# *5 - drop index
# *6 - *8 - compute distinct values for various number of threads (not indexed)
# *9 - drop the dataset
Actors:
- Name: DropIndex
  Type: RunCommand
  Database: *db
  Phases:
    OnlyActiveInPhases:
      Active: [5, 15, 25]
      NopInPhasesUpTo: *maxPhases
      PhaseConfig:
        Repeat: 1
        Threads: 1
        Database: *db
        Operations:
        - OperationName: RunCommand
          OperationCommand:
            dropIndexes: *coll
            index: value_1

- Name: DropCollection
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [9, 19, 29]
      NopInPhasesUpTo: *maxPhases
      PhaseConfig:
        Repeat: 1
        Collection: *coll
        Operations:
        - OperationName: drop

# 10 unique values
- ActorFromTemplate:
    TemplateName: CreateDataset
    TemplateParameters:
      OnlyActiveInPhase: 0
      Cardinality: 10

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 1
      Name: "distinct_10.indexed.threads_1"
      Threads: 1

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 2
      Name: "distinct_10.indexed.threads_4"
      Threads: 4

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 3
      Name: "distinct_10.indexed.threads_8"
      Threads: 8

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 6
      Name: "distinct_10.not_indexed.threads_1"
      Threads: 1

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 7
      Name: "distinct_10.not_indexed.threads_4"
      Threads: 4

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 8
      Name: "distinct_10.not_indexed.threads_8"
      Threads: 8

# 100 unique values
- ActorFromTemplate:
    TemplateName: CreateDataset
    TemplateParameters:
      OnlyActiveInPhase: 10
      Cardinality: 100

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 11
      Name: "distinct_100.indexed.threads_1"
      Threads: 1

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 12
      Name: "distinct_100.indexed.threads_4"
      Threads: 4

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 13
      Name: "distinct_100.indexed.threads_8"
      Threads: 8

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 16
      Name: "distinct_100.not_indexed.threads_1"
      Threads: 1

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 17
      Name: "distinct_100.not_indexed.threads_4"
      Threads: 4

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 18
      Name: "distinct_100.not_indexed.threads_8"
      Threads: 8

# 10000 unique values
- ActorFromTemplate:
    TemplateName: CreateDataset
    TemplateParameters:
      OnlyActiveInPhase: 20
      Cardinality: 10000

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 21
      Name: "distinct_10000.indexed.threads_1"
      Threads: 1

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 22
      Name: "distinct_10000.indexed.threads_4"
      Threads: 4

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 23
      Name: "distinct_10000.indexed.threads_8"
      Threads: 8

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 26
      Name: "distinct_10000.not_indexed.threads_1"
      Threads: 1

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 27
      Name: "distinct_10000.not_indexed.threads_4"
      Threads: 4

- ActorFromTemplate:
    TemplateName: Distinct
    TemplateParameters:
      OnlyActiveInPhase: 28
      Name: "distinct_10000.not_indexed.threads_8"
      Threads: 8
